<div class="budget-container">
  <!-- Section 1 -->
  <div class="budget-section">
    <form id="budget-form">
      <h3>Income & Deductions</h3>
      <label>Annual Gross Salary (£):
        <input type="number" id="salary" required min="0" step="any" />
      </label>
      <label>Pension Contribution (%):
        <input type="number" id="pension_percent" required min="0" max="100" step="any" value="5" />
      </label>
      <label>Student Loan Plan:
        <select id="student_loan_plan">
          <option value="none">None</option>
          <option value="plan1">Plan 1 (before 2012)</option>
          <option value="plan2" selected>Plan 2 (after 2012)</option>
          <option value="plan4">Plan 4 (Scotland)</option>
          <option value="pgl">Postgraduate Loan</option>
        </select>
      </label>
      <button type="button" id="calc-section1">Calculate Take Home Pay</button>
    </form>
    <div id="result-section1" style="display:none; margin-top:10px;"></div>
  </div>

  <!-- Section 2 -->
  <div class="budget-section">
    <form id="bills-form">
      <h3>Bills</h3>
      <label>Take Home (£):
        <input type="number" id="take_home_manual" required />
      </label>
      <label>Monthly Rent (£):
        <input type="number" id="monthly_rent" />
      </label>
      <label>Yearly Council Tax (£):
        <input type="number" id="yearly_council_tax" />
      </label>
      <button type="button" id="calc-section2">Calculate Remaining Budget</button>
    </form>
    <div id="result-section2" style="display:none; margin-top:10px;"></div>
  </div>

  <!-- Section 3 -->
  <div class="budget-section">
    <form id="foodshop-form" onsubmit="return false;">
      <h3>Weekly Food Shop</h3>
      <label>Remaining After Bills (£):
        <input type="number" id="remaining_after_bills_manual" required />
      </label>
      <div style="display:flex; gap:10px;">
        <label style="flex:1;">Item:<input type="text" id="food_item_name" /></label>
        <label style="flex:1;">Price (£):<input type="number" id="food_item_price" /></label>
      </div>
      <button type="button" id="add-food-item">Add Item</button>
    </form>
    <div id="foodshop-list" style="margin-top:10px;"></div>
    <button type="button" id="calc-food-shop">Calculate Food Shop</button>
    <div id="foodshop-result-wrapper" style="display:none; margin-top:10px;">
      <div id="foodshop-result"></div>
    </div>
  </div>

  <!-- Section 4: Luxury Items -->
  <div class="budget-section">
    <form id="luxuryshop-form" onsubmit="return false;">
      <h3>Luxury Items</h3>
      <label>Remaining After Bills (£):
        <input type="number" id="luxury_remaining_manual" required />
      </label>
      <div style="display:flex; gap:10px;">
        <label style="flex:1;">Item:<input type="text" id="luxury_item_name" /></label>
        <label style="flex:1;">Price (£):<input type="number" id="luxury_item_price" /></label>
      </div>
      <button type="button" id="add-luxury-item">Add Item</button>
    </form>
    <div id="luxuryshop-list" style="margin-top:10px;"></div>
    <button type="button" id="calc-luxury-shop">Calculate Luxury Spend</button>
    <div id="luxuryshop-result-wrapper" style="display:none; margin-top:10px;">
      <div id="luxuryshop-result"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    console.log('budget script loaded');
    const safe = id => document.getElementById(id);

    // keep track of latest remaining after food (weekly->monthly conversion already done server-side)
    let lastRemainingAfterFood = null;

    // Section 1: Take-home calculation
    const btn1 = safe('calc-section1');
    if (btn1 && !btn1.dataset.budgetAttached) {
      btn1.addEventListener('click', async () => {
        console.log('calc-section1 clicked');
        const salary = parseFloat(safe('salary')?.value || 0);
        const pension_percent = parseFloat(safe('pension_percent')?.value || 0);
        const student_loan_plan = safe('student_loan_plan')?.value || 'none';
        const resultDiv = safe('result-section1');
        if (!salary || salary <= 0) return alert('Enter a valid salary');
        resultDiv && (resultDiv.style.display = 'none');
        try {
          const res = await fetch('https://budgetcalculator-api.onrender.com/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ salary, pension_percent, student_loan_plan })
          });
          const data = await res.json();
          console.log('take-home response', data);
          safe('take_home_manual') && (safe('take_home_manual').value = data['Take Home']);
          if (resultDiv) {
            resultDiv.innerHTML = `
              Gross: £${data.Gross}<br>
              Pension: £${data.Pension}<br>
              Income Tax: £${data['Income Tax']}<br>
              NI: £${data['National Insurance']}<br>
              Student Loan: £${data['Student Loan']}<br><br>
              <strong>Take Home: £${data['Take Home']}</strong>
            `;
            resultDiv.style.display = 'block';
          }
        } catch (e) {
          console.error('calculate error', e);
          if (resultDiv) { resultDiv.innerText = 'Error calculating.'; resultDiv.style.display = 'block'; }
        }
      });
      btn1.dataset.budgetAttached = '1';
    }

    // Section 2: Remaining after bills
    const btn2 = safe('calc-section2');
    if (btn2 && !btn2.dataset.budgetAttached) {
      btn2.addEventListener('click', async () => {
        console.log('calc-section2 clicked');
        const take_home = parseFloat(safe('take_home_manual')?.value || 0);
        if (!take_home || take_home <= 0) return alert('Enter a valid take-home amount (or calculate it first)');
        const rentVal = safe('monthly_rent')?.value;
        const taxVal = safe('yearly_council_tax')?.value;
        const monthly_rent = (rentVal === '' || rentVal === undefined) ? null : parseFloat(rentVal);
        const yearly_council_tax = (taxVal === '' || taxVal === undefined) ? null : parseFloat(taxVal);
        const resultDiv = safe('result-section2');

        try {
          const res = await fetch('https://budgetcalculator-api.onrender.com/calculate_living', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              take_home,
              monthly_rent: isNaN(monthly_rent) ? null : monthly_rent,
              yearly_council_tax: isNaN(yearly_council_tax) ? null : yearly_council_tax
            })
          });
          const data = await res.json();
          console.log('living response', data);
          safe('remaining_after_bills_manual') && (safe('remaining_after_bills_manual').value = data['Remaining After Bills']);
          if (resultDiv) {
            resultDiv.innerHTML = `
              Bills: £${data.Bills}<br><br>
              <strong>Remaining: £${data['Remaining After Bills']}</strong>
            `;
            resultDiv.style.display = 'block';
          }
        } catch (e) {
          console.error('calculate_living error', e);
          if (resultDiv) { resultDiv.innerText = 'Error calculating.'; resultDiv.style.display = 'block'; }
        }
      });
      btn2.dataset.budgetAttached = '1';
    }

    // Food shop: list + calculation
    const addFoodBtn = safe('add-food-item');
    const calcFoodBtn = safe('calc-food-shop');
    const foodListEl = safe('foodshop-list');
    const foodItems = [];

    if (addFoodBtn && !addFoodBtn.dataset.attached) {
      addFoodBtn.addEventListener('click', () => {
        const name = safe('food_item_name')?.value?.trim();
        const priceRaw = safe('food_item_price')?.value;
        const price = priceRaw ? parseFloat(priceRaw) : NaN;
        if (!name) return alert('Enter an item name');
        if (isNaN(price) || price < 0) return alert('Enter a valid price');
        foodItems.push({ name, price });
        safe('food_item_name').value = '';
        safe('food_item_price').value = '';
        renderFoodList();
      });
      addFoodBtn.dataset.attached = '1';
    }

    function renderFoodList() {
      if (!foodListEl) return;
      if (foodItems.length === 0) { foodListEl.innerHTML = '<em>No items added</em>'; return; }
      const rows = foodItems.map((it, i) => `<li>${it.name}: £${it.price.toFixed(2)}</li>`).join('');
      foodListEl.innerHTML = `<ul>${rows}</ul>`;
    }

    if (calcFoodBtn && !calcFoodBtn.dataset.attached) {
      calcFoodBtn.addEventListener('click', async () => {
        const remainingRaw = safe('remaining_after_bills_manual')?.value;
        const remaining_after_bills = remainingRaw ? parseFloat(remainingRaw) : 0;
        if (!remaining_after_bills || isNaN(remaining_after_bills)) return alert('Enter remaining after bills');
        if (foodItems.length === 0) return alert('Add food items first');
        try {
          const res = await fetch('https://budgetcalculator-api.onrender.com/calculate_foodshop', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: foodItems, remaining_after_bills })
          });
          const data = await res.json();
          // store the post-food remaining so luxury can use it
          lastRemainingAfterFood = Number(data.remaining_after_food);
          // if luxury input exists, update it to reflect the chain
          const luxInput = safe('luxury_remaining_manual');
          if (luxInput) luxInput.value = lastRemainingAfterFood;
          const wrap = safe('foodshop-result-wrapper');
          const out = safe('foodshop-result');
          if (out) {
            out.innerHTML = `
              Weekly Total: £${Number(data.total).toFixed(2)}<br>
              Monthly: £${Number(data.monthly_total).toFixed(2)}<br>
              <strong>Remaining after food: £${Number(data.remaining_after_food).toFixed(2)}</strong>
            `;
          }
          if (wrap) wrap.style.display = 'block';
        } catch (e) {
          console.error('foodshop error', e);
          const out = safe('foodshop-result');
          if (out) out.innerText = 'Error calculating food shop.';
        }
      });
      calcFoodBtn.dataset.attached = '1';
    }

    // --- Luxury shop: list + calculation (mirror of food shop) ---
    const addLuxuryBtn = safe('add-luxury-item');
    const calcLuxuryBtn = safe('calc-luxury-shop');
    const luxuryListEl = safe('luxuryshop-list');
    const luxuryItems = [];

    if (addLuxuryBtn && !addLuxuryBtn.dataset.attached) {
      addLuxuryBtn.addEventListener('click', () => {
        const name = safe('luxury_item_name')?.value?.trim();
        const priceRaw = safe('luxury_item_price')?.value;
        const price = priceRaw ? parseFloat(priceRaw) : NaN;
        if (!name) return alert('Enter an item name');
        if (isNaN(price) || price < 0) return alert('Enter a valid price');
        luxuryItems.push({ name, price });
        safe('luxury_item_name').value = '';
        safe('luxury_item_price').value = '';
        renderLuxuryList();
      });
      addLuxuryBtn.dataset.attached = '1';
    }

    function renderLuxuryList() {
      if (!luxuryListEl) return;
      if (luxuryItems.length === 0) { luxuryListEl.innerHTML = '<em>No items added</em>'; return; }
      const rows = luxuryItems.map((it, i) => `<li>${it.name}: £${it.price.toFixed(2)}</li>`).join('');
      luxuryListEl.innerHTML = `<ul>${rows}</ul>`;
    }

    if (calcLuxuryBtn && !calcLuxuryBtn.dataset.attached) {
      calcLuxuryBtn.addEventListener('click', async () => {
        // prefer the chained post-food remaining if available
        const remainingRaw = safe('luxury_remaining_manual')?.value;
        const inputRemaining = remainingRaw ? parseFloat(remainingRaw) : 0;
        const baseRemaining = (lastRemainingAfterFood !== null && !isNaN(lastRemainingAfterFood))
          ? lastRemainingAfterFood
          : inputRemaining;

        if (!baseRemaining || isNaN(baseRemaining)) return alert('Enter remaining after bills (or calculate food shop first)');
        if (luxuryItems.length === 0) return alert('Add luxury items first');

        try {
          // reuse same
